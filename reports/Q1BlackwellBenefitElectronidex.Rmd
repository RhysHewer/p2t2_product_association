---
output:
  html_document:
    code_folding: hide
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_float: yes
---
## Would Blackwell benefit from selling any of Electronidex's items?


```{r message=FALSE} 
#load libraries
library(dplyr)
library(tidyr)
library(ggplot2)
library(RColorBrewer)
library(tibble)
library(arules)
library(arulesViz)
library(caret)
library(readr)
library(pdftools)
library(stringr)
library(gridExtra)
library(kableExtra)
```

### Approach

To answer the question of whether Blackwell would benefit from selling any of Electronidex's products we need a way to compare the products sold between the two companies. By doing this and, additionally, using the transaction data from Electronidex we can see whether there are any relationships between the shared products and the electronidex products which would suggest that Blackwell should stock products they currently do not.

Ideally, the products would be compared on an item-for-item basis. As this is not available, the products will be compared on a product-type-for-product-type basis.

The process to be used for this is as follows:

* Collate the product type information of the Electronidex items.
* Convert the transactional data from item to product type.
* Explore positive associations between shared product types (product types stocked both by both Blackwell and Electronidex) and Electronidex-only products.
* For Electronidex-only product types with positive relationships to shared product types, make recommendations about which of these Blackwell should sell.

### Data pre-processing
```{r warning=FALSE}
#load csv data
transData <- read.transactions("C:/Users/rhysh/Google Drive/Data Science/Ubiqum/Project 2/Task 4/data/ElectronidexTransactions2017.csv", format = "basket", sep = ",")
prodData <- read.csv("C:/Users/rhysh/Google Drive/Data Science/Ubiqum/Project 2/Task 4/data/ElectronidexTransactions2017.csv", header = FALSE)


### Loading PDF Elecronited product type data
text <- pdf_text("C:/Users/rhysh/Google Drive/Data Science/Ubiqum/Project 2/Task 4/data/ElectronidexItems2017.pdf")

text2 <- strsplit(text, "\n")
text2 <- text2 %>% unlist(recursive = TRUE)

text3 <- gsub("\r", "", text2)

prod.list <- text3 %>% as.data.frame()

##create product type lists
laptop.list <- prod.list[2:11,1] %>% as.character() %>% trimws("l")
desktop.list <- prod.list[13:21,1] %>% as.character() %>% trimws("l")
monitor.list <- prod.list[23:32,1] %>% as.character() %>% trimws("l")
mice.list <- prod.list[34:43,1] %>% as.character() %>% trimws("l")
keyboard.list <- prod.list[45:53,1] %>% as.character() %>% trimws("l")
mousekeyboard.list <- prod.list[55:63,1] %>% as.character() %>% trimws("l")
compheadphones.list <- prod.list[64:74,1] %>% as.character() %>% trimws("l")
activeheadphones.list <- prod.list[76:81,1] %>% as.character() %>% trimws("l")
compcords.list <- prod.list[83:91,1] %>% as.character() %>% trimws("l")
accessories.list <- prod.list[93:96,1] %>% as.character() %>% trimws("l")
speakers.list <- prod.list[98:106,1] %>% as.character() %>% trimws("l")
printers.list <- prod.list[108:112,1] %>% as.character() %>% trimws("l")
printink.list <- prod.list[114:118,1] %>% as.character() %>% trimws("l")
compstands.list <- prod.list[120:124,1] %>% as.character() %>% trimws("l")
comptablets.list <- prod.list[126:130,1] %>% as.character() %>% trimws("l")
extdrives.list <- prod.list[132:136,1] %>% as.character() %>% trimws("l")
smarthome.list <- prod.list[138:142,1] %>% as.character() %>% trimws("l")

##additional products added to lists
laptop.list <- c(laptop.list, "Alienware Laptop", "Apple MacBook Pro", "Eluktronics Pro Gaming Laptop", "ASUS Chromebook")
activeheadphones.list <- c(activeheadphones.list, "Panasonic On-Ear Stereo Headphones", "APIE Bluetooth Headphone", 
                           "Otium Wireless Sports Bluetooth Headphone", "Philips Flexible Earhook Headphone")
comptablets.list <- c(comptablets.list, "tabletlet", "tablet Pro")
printink.list <- c(printink.list, "printer Toner")
extdrives.list <- c(extdrives.list, "Slim extdrive")

#string replacement lists
prodReplace <- function(x,y){
        list1 <- x %>% as.data.frame()
        list1$name <- y
        list2 <- list1$name
        names(list2) <- list1$.
        list2
}

laptop.replace <- prodReplace(laptop.list, "laptop")
desktop.replace <- prodReplace(desktop.list, "desktop")
monitor.replace <- prodReplace(monitor.list, "monitor")
mice.replace <- prodReplace(mice.list, "mouse")
keyboard.replace <- prodReplace(keyboard.list, "keyboard")
mousekeyboard.replace <- prodReplace(mousekeyboard.list, "mousekeyboard")
compheadphones.replace <- prodReplace(compheadphones.list, "compheadphones")
activeheadphones.replace <- prodReplace(activeheadphones.list, "activeheadphones")
compcords.replace <- prodReplace(compcords.list, "compcord")
accessories.replace <- prodReplace(accessories.list, "accessories")
speakers.replace <- prodReplace(speakers.list, "speaker")
printers.replace <- prodReplace(printers.list, "printer")
printink.replace <- prodReplace(printink.list, "printink")
compstands.replace <- prodReplace(compstands.list, "compstand")
comptablets.replace <- prodReplace(comptablets.list, "tablet")
extdrives.replace <- prodReplace(extdrives.list, "extdrive")
smarthome.replace <- prodReplace(smarthome.list, "smarthome")

#String replacement function
stringReplace <- function(z){
        inList <- z
        repLace <- prodData
        repLace <- sapply(repLace, function(x) str_replace_all(x, inList))
        data.frame(repLace)
}

productList <- c(laptop.replace, desktop.replace, monitor.replace, mice.replace, keyboard.replace, mousekeyboard.replace,
                 compheadphones.replace, activeheadphones.replace, compcords.replace, accessories.replace, speakers.replace,
                 printers.replace, printink.replace, compstands.replace, comptablets.replace, extdrives.replace, smarthome.replace)

typePrep <- stringReplace(productList)

#not all products were included on product type list
# "Alienware Laptop", "Apple MacBook Pro", "Eluktronics Pro Gaming Laptop", "Panasonic On-Ear Stereo Headphones", 
# "tabletlet", "APIE Bluetooth Headphone", "ASUS Chromebook", "Otium Wireless Sports Bluetooth Headphone",  "printer Toner" 
# "Philips Flexible Earhook Headphone", "Slim extdrive", "tablet Pro"  - added to relevant product replacement lists    


#CSV creation/re-import
write.table(typePrep, file = "C:/Users/rhysh/Google Drive/Data Science/Ubiqum/Project 2/Task 4/output/typePrep.csv", sep=",", row.names = FALSE, col.names = FALSE)
typeData <- read.transactions("C:/Users/rhysh/Google Drive/Data Science/Ubiqum/Project 2/Task 4/output/typePrep.csv", format = "basket", sep=",")

summary(typeData)

```

### Generate Electronidex Association Rules

```{r}
### Generate association rules and convert to dataframe for manipulation
basketRulesType <- apriori(typeData, parameter = list(supp = 0.01, conf = 0.1, minlen = 2))
basketFrameType <- data.frame(
        lhs = labels(lhs(basketRulesType)),
        rhs = labels(rhs(basketRulesType)), 
        basketRulesType@quality)

```

The association rules are generated for the whole Electronidex product type set. Low barriers are set for the creation of the rules and the output is converted to a dataframe for ease of manipulation.


There are two directions to explore within these transactions. These are:

* Shared product types which are associated with purchases of Electronidex-only product types
* Electronidex-only product types which are associated with purchases of shared product types

These will be investigated in-turn.

#### Shared product types which are associated with purchases of Electronidex-only product types

```{r}
##Filter based on LHS shared products and support/confidence/lift metrics summarise these
sharedProducts <- ("accessories|monitor|laptop|desktop|printer|printink|tablet")
notSharedProducts <- ("mouse|keyboard|mousekeyboard|compheadphones|activeheadphones|compcord|speaker|compstand|
                      extdrive|smarthome")

basketLeft <- basketFrameType %>% filter(!grepl(notSharedProducts, lhs)) %>%
        filter(support > 0.05, confidence > 0.6, lift > 1)

basketLeftAvg <- basketLeft %>% group_by(rhs) %>%
        summarise(avgSupport = mean(support), avgConfidence = mean(confidence), avgLift = mean(lift))

kable(basketLeftAvg) %>%
        kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```

The association rules are generated with the following limits:

* Support > 0.05: This represents itemsets that occur more than 5% of the time
* Confidence > 0.6: This represents the RHS items occuring at least 60% of the time the LHS occur
* Lift > 1: This ensures that the itemsets are not independent and that the relationship is positive (each side of the itemset increases the chance of the other side occuring)

The association rules were then filtered so that rules where only shared product types were contained within the LHS remained. The RHS product types were summarised to give a general picture of the positive association between the shared products and the product types with which they have a positive relationship.

We see that within the limits we set there are no Electronidex-only product types which are sufficiently positively associated with the shared product types, and by extension, the Blackwell product types.

#### Electronidex-only product types which are associated with purchases of shared product types

```{r}
basketRight <- basketFrameType %>% filter(!grepl(notSharedProducts, rhs)) %>%
        filter(support > 0.05, confidence > 0.6, lift > 1)
```

The association rules are generated with the following limits:

* Support > 0.05: This represents itemsets that occur more than 5% of the time
* Confidence > 0.6: This represents the RHS items occuring at least 60% of the time the LHS occur
* Lift > 1: This ensures that the itemsets are not independent and that the relationship is positive (each side of the itemset increases the chance of the other side occuring)

The association rules were then filtered so that rules where only shared product types were contained within the RHS remained.

The following plot was produced:

```{r}
g5 <- ggplot(basketRight, aes(rhs, lhs)) +
        geom_count(aes(size = confidence, colour = support)) +
        scale_colour_gradient(low = "skyblue", high = "darkblue") +
        theme_bw() +
        ylab("LHS Itemset") + 
        xlab("Shared Product Type") + 
        ggtitle("Association Rules: RHS shared products")
g5

```

At first glance it seems that there are a number of potentially interesting associations to explore. However, when a closer look is taken, some questions regarding customer behaviour arise.

By looking more in-depth at fewer rules these questions become more apparent.

```{r}
basketRightFocus <- basketRight %>% filter(support > 0.075, confidence > 0.75, lift > 1.2)

kable(basketRightFocus) %>%
        kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```

The above data are generated from the most positive association rules, with metrics of:

* Support > 0.075: This represents itemsets that occur more than 7.5% of the time
* Confidence > 0.75: This represents the RHS items occuring at least 75% of the time the LHS occur
* Lift > 1.2: This ensures that the itemsets are not independent and that the relationship is significantly positive (each side of the itemset increases the chance of the other side occuring)

All the transactions have a positive association with a desktop being purchased. What is noteworthy, however, is that in 50% of the listed transactions, a laptop is also purchased. In consumer purchases, desktops and laptops are infrequently purchased together. Electronidex sales patterns are more indicative of a business-to-business wholesaler and, as such, their utility in comparing to Blackwell's business-to-consumer model is diminished. 

The directionality of the association is also a concern. Whilst the rules are correlative rather than causative, they do seem to suggest that the less expensive peripherals have a positive impact on whether a desktop is purchased and also that buying a laptop (a product which usually replaces a desktop) has a positive impact on whether a desktop is purchased.

One would usually expect the purchase of the more expensive primary items to drive the purchase of the less expensive secondary items - Rarely have I purchased a mouse and thought 'I probably need a desktop with that' - but this is not the pattern here. Also, if there was this type of relationship, one would expect it to be reciprocated when the desktop is on the LHS of the itemset. As we saw, previously, this was not the case.

#### Conclusion: Would Blackwell benefit from selling any of Electronidex's items?

Reviewing the associations generated by the shared products being on the LHS we saw that only the products that we already sell have a positive association with the shared products itemsets. This suggests that we are not missing out on product types, currently being sold by Electronidex, that would likely sell alongside the exisiting shared product types sold by Blackwell.

We see that there are items that seem to have a positive impact on the sales of product types currently stocked by Blackwell but that these patterns are questionable due to the difference in customer behaviour between our businesses.

I would recommend a small trial based on the top-frequency products within the product types most associated with a positive impact current Blackwell products.

Based on our focussed dataset, these product types are:

* Mouse & Keyboard combination
* Active Headphones
* Keyboard
* Mouse

We do not have information about sales volume, price or profitablility for the Electronidex products. Frequency of appearance in the basket has been used as a proxy for these.

The recommended products are:
```{r}
## Most frequent Electronidex products - Mouse & Keyboard combination/Active Headphones/Keyboard/Mouse
freq <- itemFrequency(transData) %>% as.data.frame %>% rownames_to_column()
colnames(freq) <- c("rowNames", "support")

is.keyboard <- freq$rowNames %in% keyboard.list
freq$prodType[is.keyboard] <- "keyboard"

is.mouse <- freq$rowNames %in% mice.list
freq$prodType[is.mouse] <- "mouse"

is.mousekeyboard <- freq$rowNames %in% mousekeyboard.list
freq$prodType[is.mousekeyboard] <- "mousekeyboard"

is.activeheadphones <- freq$rowNames %in% activeheadphones.list
freq$prodType[is.activeheadphones] <- "activeheadphones"

#Blackwell don't stock apple desktops or laptops (only smartphone) so remove apple peripherals
freq <- freq %>% filter(!str_detect(rowNames, "Apple"))

freq.filter <- freq %>% na.omit() %>% group_by(prodType) %>%
        top_n(n = 2, wt = support) %>% arrange(prodType)

kable(freq.filter) %>%
        kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```



