---
output:
  html_document:
    code_folding: hide
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_float: yes
---
## Would Blackwell benefit from selling any of Electronidex's items?


```{r message=FALSE} 
#load libraries
library(dplyr)
library(tidyr)
library(ggplot2)
library(RColorBrewer)
library(tibble)
library(arules)
library(arulesViz)
library(caret)
library(readr)
library(pdftools)
library(stringr)
library(gridExtra)
```

### Approach

To answer the question of whether Blackwell would benefit from selling any of Electroidex's products we need a way to compare the products sold between the two companies. By doing this and, additionally, using the transaction data from Electronidex we can see whether there are any relationships between the shared products and the electronidex products which would suggest that Blackwell should stock products they currently do not.

Ideally, the products would be compared on an item-for-item basis. As this is not available, the products will be compared on a product-type-for-product-type basis.

The process to be used for this is as follows:

* Collate the product type information of the Electronidex items.
* Convert the transactional data from item to product type.
* Explore positive associations between shared product types (product types stocked both by both Blackwell and Electronidex) and Electronidex-only products.
* For Electronidex-only product types with positive relationships to shared product types, make recommendations about which of these Blackwell should sell.

### Data pre-processing
```{r warning=FALSE}
#load csv data
transData <- read.transactions("C:/Users/rhysh/Google Drive/Data Science/Ubiqum/Project 2/Task 4/data/ElectronidexTransactions2017.csv", format = "basket", sep = ",")
prodData <- read.csv("C:/Users/rhysh/Google Drive/Data Science/Ubiqum/Project 2/Task 4/data/ElectronidexTransactions2017.csv", header = FALSE)


### Loading PDF Elecronited product type data
text <- pdf_text("C:/Users/rhysh/Google Drive/Data Science/Ubiqum/Project 2/Task 4/data/ElectronidexItems2017.pdf")

text2 <- strsplit(text, "\n")
text2 <- text2 %>% unlist(recursive = TRUE)

text3 <- gsub("\r", "", text2)

prod.list <- text3 %>% as.data.frame()

##create product type lists
laptop.list <- prod.list[2:11,1] %>% as.character() %>% trimws("l")
desktop.list <- prod.list[13:21,1] %>% as.character() %>% trimws("l")
monitor.list <- prod.list[23:32,1] %>% as.character() %>% trimws("l")
mice.list <- prod.list[34:43,1] %>% as.character() %>% trimws("l")
keyboard.list <- prod.list[45:53,1] %>% as.character() %>% trimws("l")
mousekeyboard.list <- prod.list[55:63,1] %>% as.character() %>% trimws("l")
compheadphones.list <- prod.list[64:74,1] %>% as.character() %>% trimws("l")
activeheadphones.list <- prod.list[76:81,1] %>% as.character() %>% trimws("l")
compcords.list <- prod.list[83:91,1] %>% as.character() %>% trimws("l")
accessories.list <- prod.list[93:96,1] %>% as.character() %>% trimws("l")
speakers.list <- prod.list[98:106,1] %>% as.character() %>% trimws("l")
printers.list <- prod.list[108:112,1] %>% as.character() %>% trimws("l")
printink.list <- prod.list[114:118,1] %>% as.character() %>% trimws("l")
compstands.list <- prod.list[120:124,1] %>% as.character() %>% trimws("l")
comptablets.list <- prod.list[126:130,1] %>% as.character() %>% trimws("l")
extdrives.list <- prod.list[132:136,1] %>% as.character() %>% trimws("l")
smarthome.list <- prod.list[138:142,1] %>% as.character() %>% trimws("l")

##additional products added to lists
laptop.list <- c(laptop.list, "Alienware Laptop", "Apple MacBook Pro", "Eluktronics Pro Gaming Laptop", "ASUS Chromebook")
activeheadphones.list <- c(activeheadphones.list, "Panasonic On-Ear Stereo Headphones", "APIE Bluetooth Headphone", 
                           "Otium Wireless Sports Bluetooth Headphone", "Philips Flexible Earhook Headphone")
comptablets.list <- c(comptablets.list, "tabletlet", "tablet Pro")
printink.list <- c(printink.list, "printer Toner")
extdrives.list <- c(extdrives.list, "Slim extdrive")

#string replacement lists
prodReplace <- function(x,y){
        list1 <- x %>% as.data.frame()
        list1$name <- y
        list2 <- list1$name
        names(list2) <- list1$.
        list2
}

laptop.replace <- prodReplace(laptop.list, "laptop")
desktop.replace <- prodReplace(desktop.list, "desktop")
monitor.replace <- prodReplace(monitor.list, "monitor")
mice.replace <- prodReplace(mice.list, "mouse")
keyboard.replace <- prodReplace(keyboard.list, "keyboard")
mousekeyboard.replace <- prodReplace(mousekeyboard.list, "mousekeyboard")
compheadphones.replace <- prodReplace(compheadphones.list, "compheadphones")
activeheadphones.replace <- prodReplace(activeheadphones.list, "activeheadphones")
compcords.replace <- prodReplace(compcords.list, "compcord")
accessories.replace <- prodReplace(accessories.list, "accessories")
speakers.replace <- prodReplace(speakers.list, "speaker")
printers.replace <- prodReplace(printers.list, "printer")
printink.replace <- prodReplace(printink.list, "printink")
compstands.replace <- prodReplace(compstands.list, "compstand")
comptablets.replace <- prodReplace(comptablets.list, "tablet")
extdrives.replace <- prodReplace(extdrives.list, "extdrive")
smarthome.replace <- prodReplace(smarthome.list, "smarthome")

#String replacement function
stringReplace <- function(z){
        inList <- z
        repLace <- prodData
        repLace <- sapply(repLace, function(x) str_replace_all(x, inList))
        data.frame(repLace)
}

productList <- c(laptop.replace, desktop.replace, monitor.replace, mice.replace, keyboard.replace, mousekeyboard.replace,
                 compheadphones.replace, activeheadphones.replace, compcords.replace, accessories.replace, speakers.replace,
                 printers.replace, printink.replace, compstands.replace, comptablets.replace, extdrives.replace, smarthome.replace)

typePrep <- stringReplace(productList)

#not all products were included on product type list
# "Alienware Laptop", "Apple MacBook Pro", "Eluktronics Pro Gaming Laptop", "Panasonic On-Ear Stereo Headphones", 
# "tabletlet", "APIE Bluetooth Headphone", "ASUS Chromebook", "Otium Wireless Sports Bluetooth Headphone",  "printer Toner" 
# "Philips Flexible Earhook Headphone", "Slim extdrive", "tablet Pro"  - added to relevant product replacement lists    


#CSV creation/re-import
write.table(typePrep, file = "C:/Users/rhysh/Google Drive/Data Science/Ubiqum/Project 2/Task 4/output/typePrep.csv", sep=",", row.names = FALSE, col.names = FALSE)
typeData <- read.transactions("C:/Users/rhysh/Google Drive/Data Science/Ubiqum/Project 2/Task 4/output/typePrep.csv", format = "basket", sep=",")

summary(typeData)

```

### Generate Electronidex Association Rules

```{r}
### Generate association rules and convert to dataframe for manipulation
basketRulesType <- apriori(typeData, parameter = list(supp = 0.01, conf = 0.1, minlen = 2))
basketFrameType <- data.frame(
        lhs = labels(lhs(basketRulesType)),
        rhs = labels(rhs(basketRulesType)), 
        basketRulesType@quality)

```

The association rules are generated for the whole Electronidex product type set. Low barriers are set for the creation of the rules and the output is converted to a dataframe for ease of manipulation.


There are two directions to explore within these transactions. These are:

* Shared product types which are associated with purchases of Electronidex-only product types
* Electronidex-only product types which are associated with purchases of shared product types

These will be investigated in-turn.

#### Shared product types which are associated with purchases of Electronidex-only product types

```{r}
##Filter based on LHS shared products and support/confidence/lift metrics summarise these
sharedProducts <- ("accessories|monitor|laptop|desktop|printer|printink|tablet")
notSharedProducts <- ("mouse|keyboard|mousekeyboard|compheadphones|activeheadphones|compcord|speaker|compstand|
                      extdrive|smarthome")

basketLeft <- basketFrameType %>% filter(!grepl(notSharedProducts, lhs)) %>%
        filter(support > 0.05, confidence > 0.6, lift > 1)

basketLeftAvg <- basketLeft %>% group_by(rhs) %>%
        summarise(avgSupport = mean(support), avgConfidence = mean(confidence), avgLift = mean(lift))
basketLeftAvg
```

The association rules are generated with the following limits:

* Support > 0.05: This represents itemsets that occur more than 5% of the time
* Confidence > 0.6: This represents the RHS items occuring at least 60% of the time the LHS occur
* Lift > 1: This ensures that the itemsets are not independent and that the relationship is positive (each side of the itemset increases the chance of the other side occuring)

The association rules were then filtered so that rules where only shared product types were contained within the LHS remained. The RHS product types were summarised to give a general picture of the positive association between the shared products and the product types with which they have a positive relationship.

We see that within the limits we set there are no Electronidex-only product types which are sufficiently positively associated with the shared product types, and by extension, the Blackwell product types.

#### Electronidex-only product types which are associated with purchases of shared product types


